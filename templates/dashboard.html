{% extends "base.html" %}

{% block title %}Dashboard - SURVION{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-shield-alt accent-highlight"></i>
            <h3>SUR<span class="accent-highlight">VION</span></h3>
        </div>
        
                <div class="sidebar-menu">            <ul>                <li><a href="#" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>                <li><a href="{{ url_for('servilance') }}"><i class="fas fa-video accent-highlight"></i> Surveillance</a></li>                <li><a href="{{ url_for('owner_faces') }}"><i class="fas fa-user-circle accent-highlight"></i> Face Recognition</a></li>                <li><a href="{{ url_for('screenshots') }}"><i class="fas fa-images"></i> Screenshots</a></li>                <li><a href="#"><i class="fas fa-history"></i> Activity Log</a></li>                <li><a href="#"><i class="fas fa-chart-bar accent-highlight"></i> Analytics</a></li>                <li><a href="#"><i class="fas fa-microchip"></i> BlueCore</a></li>                <li><a href="#"><i class="fas fa-cog accent-highlight"></i> Settings</a></li>                <li><a href="{{ url_for('profile') }}"><i class="fas fa-user"></i> Profile</a></li>                <li><a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Logout</a></li>            </ul>        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="dashboard-header">
            <h2>Command <span class="accent-highlight">Center</span></h2>
            <div>
                <span class="neon-text">Welcome, <strong class="accent-highlight">{{ session.get('user_id') }}</strong></span>
            </div>
        </div>
        
        <!-- Dashboard Cards -->
        <div class="dashboard-cards">
            <div class="dashboard-card neon-element">
                <h3><i class="fas fa-satellite"></i> Active Monitors</h3>
                <div class="value">6</div>
                <p>All monitoring systems operational</p>
            </div>
            
            <div class="dashboard-card neon-element accent-border">
                <h3><i class="fas fa-exclamation-triangle accent-highlight"></i> Security Alerts</h3>
                <div class="value accent-highlight">3</div>
                <p>1 high priority, 2 standard</p>
            </div>
            
            <div class="dashboard-card neon-element">
                <h3><i class="fas fa-shield-alt"></i> BlueCore Status</h3>
                <div class="value">Optimal</div>
                <p>Neural networks functioning at 99.8% efficiency</p>
            </div>
            
            <div class="dashboard-card neon-element accent-border">
                <h3><i class="fas fa-chart-line accent-highlight"></i> Detection Rate</h3>
                <div class="value accent-highlight">99.8%</div>
                <p>+2.3% from previous calibration</p>
            </div>
        </div>
        
        <!-- Surveillance Quick Access -->
        <div class="dashboard-section">
            <h3>Suspicious Activity <span class="accent-highlight">Detection</span></h3>
            <div class="dashboard-action-card neon-element accent-border">
                <div class="action-content">
                    <div>
                        <h4><i class="fas fa-video accent-highlight"></i> Real-time Surveillance</h4>
                        <p>Monitor and detect suspicious activities with our advanced AI detection system.</p>
                    </div>
                    <a href="{{ url_for('servilance') }}" class="btn accent-bg">Access Surveillance</a>
                </div>
            </div>
        </div>
        
        <!-- Recent Activity -->
        <div class="dashboard-section">
            <h3>Security <span class="accent-highlight">Incidents</span></h3>
            <div class="activity-list">
                <div class="activity-item neon-element">
                    <div class="activity-icon"><i class="fas fa-exclamation-circle"></i></div>
                    <div class="activity-details">
                        <h4>Unauthorized Access Attempt</h4>
                        <p>Sector B - Quantum Server Room</p>
                        <span class="activity-time">Today, 15:42</span>
                    </div>
                    <div class="activity-action">
                        <a href="#" class="btn btn-sm accent-bg">Analyze</a>
                    </div>
                </div>
                
                <div class="activity-item neon-element">
                    <div class="activity-icon"><i class="fas fa-running accent-highlight"></i></div>
                    <div class="activity-details">
                        <h4>Anomalous Movement Pattern</h4>
                        <p>Camera #4 - Research Laboratory</p>
                        <span class="activity-time">Today, 14:23</span>
                    </div>
                    <div class="activity-action">
                        <a href="#" class="btn btn-sm btn-primary">Review</a>
                    </div>
                </div>
                
            </div>
        </div>
        
        <!-- Email Alert Settings -->
        <div class="dashboard-section">
            <h3>Email <span class="accent-highlight">Alert Settings</span></h3>
            <div class="dashboard-action-card neon-element accent-border">
                <div class="action-content">
                    <div>
                        <h4><i class="fas fa-envelope accent-highlight"></i> Security Alert Notifications</h4>
                        <p>Configure email alerts for suspicious activities.</p>
                    </div>
                </div>
                <div class="email-settings-form">
                    <div class="neon-alert" id="emailAlert" style="display:none;"></div>
                    <form id="emailSettingsForm" class="neon-form">
                        <div class="form-group">
                            <label for="emailInterval"><i class="fas fa-clock"></i> Alert Interval (seconds)</label>
                            <input type="number" id="emailInterval" name="emailInterval" min="5" value="30" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="mailUsername"><i class="fas fa-user"></i> Email Username</label>
                            <input type="text" id="mailUsername" name="mailUsername" class="form-control" placeholder="Your Gmail address">
                            <small class="form-text">For Gmail, use your complete email address</small>
                        </div>
                        <div class="form-group">
                            <label for="mailPassword"><i class="fas fa-lock"></i> Email Password</label>
                            <input type="password" id="mailPassword" name="mailPassword" class="form-control" placeholder="Your email password">
                            <small class="form-text">For Gmail, use an <a href="https://support.google.com/accounts/answer/185833" target="_blank">App Password</a> for best security</small>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn accent-bg">Save Settings</button>
                            <button type="button" id="testEmailBtn" class="btn btn-secondary">Test Email</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Make User Owner -->
        <div class="dashboard-section">
            <h3>Owner <span class="accent-highlight">Management</span></h3>
            <div class="dashboard-action-card neon-element accent-border">
                <div class="action-content">
                    <div>
                        <h4><i class="fas fa-user-shield accent-highlight"></i> Add Owner Account</h4>
                        <p>Make an existing user an owner to receive security alert emails.</p>
                    </div>
                </div>
                <div class="email-settings-form">
                    <div class="neon-alert" id="ownerAlert" style="display:none;"></div>
                    <form id="makeOwnerForm" class="neon-form">
                        <div class="form-group">
                            <label for="ownerUsername"><i class="fas fa-user"></i> Username</label>
                            <input type="text" id="ownerUsername" name="ownerUsername" class="form-control" placeholder="Enter existing username">
                            <small class="form-text">Enter the username of an existing account you want to make an owner</small>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn accent-bg">Make Owner</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- System Performance -->
        <div class="dashboard-section">
            <h3>System <span class="accent-highlight">Performance</span></h3>
            <div class="dashboard-cards">
                <div class="dashboard-card neon-element">
                    <h3><i class="fas fa-microchip"></i> Quantum Processing</h3>
                    <div class="value">87%</div>
                    <p>Neural network capacity</p>
                </div>
                
                <div class="dashboard-card neon-element accent-border">
                    <h3><i class="fas fa-memory accent-highlight"></i> Memory Allocation</h3>
                    <div class="value accent-highlight">42%</div>
                    <p>6.2 TB of 15 TB utilized</p>
                </div>
                
                <div class="dashboard-card neon-element">
                    <h3><i class="fas fa-tachometer-alt"></i> Response Time</h3>
                    <div class="value">0.05s</div>
                    <p>Average alert generation speed</p>
                </div>
                
                <div class="dashboard-card neon-element accent-border">
                    <h3><i class="fas fa-cloud-upload-alt accent-highlight"></i> Data Sync</h3>
                    <div class="value accent-highlight">100%</div>
                    <p>Last sync: 2 minutes ago</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add JavaScript for the email settings form -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const emailForm = document.getElementById('emailSettingsForm');
    const testEmailBtn = document.getElementById('testEmailBtn');
    const emailAlert = document.getElementById('emailAlert');
    const makeOwnerForm = document.getElementById('makeOwnerForm');
    const ownerAlert = document.getElementById('ownerAlert');
    
    // Setup Socket.IO connection for real-time updates
    const socket = io();
    
    // Listen for email test results from socket
    socket.on('email_test_result', function(data) {
        if (data.status === 'success') {
            showAlert(emailAlert, 'Test email sent successfully! Check your inbox.', 'success');
        } else {
            showAlert(emailAlert, 'Email test failed: ' + data.message, 'error');
        }
        
        // Reset button state
        testEmailBtn.disabled = false;
        testEmailBtn.innerHTML = 'Test Email';
    });
    
    // Function to show alerts
    function showAlert(alert, message, type) {
        alert.innerHTML = message;
        alert.className = 'neon-alert ' + (type === 'success' ? 'success' : 'error');
        alert.style.display = 'block';
        
        // Scroll to alert
        alert.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Hide after 10 seconds
        setTimeout(() => {
            alert.style.display = 'none';
        }, 10000);
    }
    
    // Handle email settings form submission
    emailForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            email_interval: document.getElementById('emailInterval').value,
            mail_username: document.getElementById('mailUsername').value,
            mail_password: document.getElementById('mailPassword').value
        };
        
        // Basic validation
        if (!formData.mail_username || !formData.mail_password) {
            showAlert(emailAlert, 'Please provide both email username and password.', 'error');
            return;
        }
        
        fetch('/update_email_settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData),
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showAlert(emailAlert, 'Email settings updated successfully. You can test your settings with the Test Email button.', 'success');
            } else {
                showAlert(emailAlert, 'Error: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert(emailAlert, 'An error occurred while updating email settings', 'error');
        });
    });
    
    // Handle test email button click
    testEmailBtn.addEventListener('click', function() {
        // First check if credentials are filled
        const username = document.getElementById('mailUsername').value;
        const password = document.getElementById('mailPassword').value;
        
        if (!username || !password) {
            showAlert(emailAlert, 'Please save your email settings first before testing.', 'error');
            return;
        }
        
        // Show loading state
        testEmailBtn.disabled = true;
        testEmailBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
        
        // Call test email endpoint
        fetch('/test_email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'pending') {
                // Test is running in background, keep waiting for Socket.IO event
                showAlert(emailAlert, 'Email test started. Please wait for results...', 'success');
            } else if (data.status === 'success') {
                showAlert(emailAlert, 'Test email sent successfully! Check your inbox.', 'success');
                // Reset button state
                testEmailBtn.disabled = false;
                testEmailBtn.innerHTML = 'Test Email';
            } else {
                showAlert(emailAlert, 'Email test failed: ' + data.message, 'error');
                // Reset button state
                testEmailBtn.disabled = false;
                testEmailBtn.innerHTML = 'Test Email';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert(emailAlert, 'An error occurred while testing email settings', 'error');
            // Reset button state
            testEmailBtn.disabled = false;
            testEmailBtn.innerHTML = 'Test Email';
        });
    });
    
    // Handle make owner form submission
    makeOwnerForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const username = document.getElementById('ownerUsername').value.trim();
        
        if (!username) {
            showAlert(ownerAlert, 'Please enter a username.', 'error');
            return;
        }
        
        // Show loading
        const submitBtn = makeOwnerForm.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        
        // Call make owner endpoint
        fetch('/make_owner', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ username: username })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showAlert(ownerAlert, 'User "' + username + '" is now an owner and will receive security alerts.', 'success');
                // Clear the input field
                document.getElementById('ownerUsername').value = '';
            } else {
                showAlert(ownerAlert, 'Error: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert(ownerAlert, 'An error occurred while updating owner status', 'error');
        })
        .finally(() => {
            // Reset button state
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Make Owner';
        });
    });
});
</script>
{% endblock %} 